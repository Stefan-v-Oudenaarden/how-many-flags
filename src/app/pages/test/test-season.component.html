<div class="min-h-screen bg-linear-to-br from-blue-50 via-indigo-50 to-purple-50">
  <app-top-nav activeItem="Test Season"></app-top-nav>
  <div class="max-w-450 mx-auto p-4">
    <!-- Edit Modal -->
    <hlm-dialog>
      <button hlmDialogTrigger hlmBtn variant="outline" class="fixed top-14 right-2 text-2xl">
        ✍️
      </button>
      <hlm-dialog-content
        *brnDialogContent="let ctx"
        class="overflow-y-auto overflow-x-hidden min-h-[70dvh] max-h-dvh"
      >
        <div class="container mx-auto p-6 pt-2 pb-2 max-w-7xl">
          <div>
            <label>Select Race: </label>
            <brn-select
              class="inline-block"
              placeholder="Select some fruit"
              [multiple]="false"
              [(value)]="selectedRaceId"
            >
              <hlm-select-trigger class="w-48">
                <hlm-select-value />
              </hlm-select-trigger>
              <hlm-select-content class="w-48">
                @for(race of raceIds();track race.id) {
                <hlm-option [value]="race.id">{{ race.name }}</hlm-option
                >}
              </hlm-select-content>
            </brn-select>
            <button
              (click)="AddRaceToSeason()"
              class="bg-transparent hover:bg-blue-500 text-blue-700 font-semibold hover:text-white py-1 px-1 ml-4 hover:border-transparent rounded"
            >
              ➕
            </button>
            <button
              (click)="ExportSeasonData()"
              class="absolute right-12 bg-transparent hover:bg-blue-500 text-blue-700 font-semibold hover:text-white px-3 h-8.5 py-1 border border-blue-500 hover:border-transparent rounded"
            >
              Export
            </button>
          </div>
        </div>

        <div class="">
          <app-result-editor
            [year]="selectedYear()"
            [raceID]="selectedRaceId()"
            (updatedData)="UpdateData()"
          ></app-result-editor>
          <app-prediction-editor
            [year]="selectedYear()"
            [raceID]="selectedRaceId()"
            (updatedData)="UpdateData()"
          ></app-prediction-editor>
        </div>
      </hlm-dialog-content>
    </hlm-dialog>

    <hlm-tabs tab="Standings" class="w-full">
      <hlm-tabs-list aria-label="Tabs">
        <button hlmTabsTrigger="Standings">Standings</button>
        <button hlmTabsTrigger="Last Race">Last Race</button>
        <button hlmTabsTrigger="Races">Races</button>
      </hlm-tabs-list>

      <div hlmTabsContent="Standings">
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
          <!-- Left Column - Overall Leaderboard -->

          <div class="space-y-4">
            <app-scoreblock-hero-v1
              [scores]="totalScores()"
              [lastRaceScores]="lastRaceScores()"
              selectedScore="totalScore"
              displayName="Overall Leaderboard"
            ></app-scoreblock-hero-v1>
          </div>

          <!-- Right Column - Categories -->
          <div class="space-4 grid grid-cols-2 gap-4">
            <!-- Flags -->
            <app-scoreblock-v1
              [scores]="totalScores()"
              [lastRaceScores]="lastRaceScores()"
              selectedScore="flagScore"
              displayName="Flags"
              displayIcon="/icons/flag-sharp.svg"
              displayIconStyle="bg-red-500"
            ></app-scoreblock-v1>

            <!-- Drivers -->
            <app-scoreblock-v1
              [scores]="totalScores()"
              [lastRaceScores]="lastRaceScores()"
              selectedScore="driverScore"
              displayName="Drivers"
              displayIcon="/icons/people-sharp.svg"
              displayIconStyle="bg-blue-500"
            ></app-scoreblock-v1>

            <!-- Winner -->
            <app-scoreblock-v1
              [scores]="totalScores()"
              [lastRaceScores]="lastRaceScores()"
              selectedScore="winnerScore"
              displayName="Winner"
              displayIcon="/icons/car-sport-sharp.svg"
              displayIconStyle="bg-yellow-500"
            ></app-scoreblock-v1>

            <!-- DNF -->
            <app-scoreblock-v1
              [scores]="totalScores()"
              [lastRaceScores]="lastRaceScores()"
              selectedScore="dnfScore"
              displayName="DNF"
              displayIcon="/icons/car-crash.svg"
              displayIconStyle="bg-gray-500"
            ></app-scoreblock-v1>
          </div>
        </div>
      </div>
      <div hlmTabsContent="Last Race">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">{{ lastRaceResults().race }}</h1>
        <app-race-view-v1
          [scores]="lastRaceScores()"
          [results]="lastRaceResults()"
          [predictions]="lastRacePrediction()"
          [participants]="lastRaceParticipants()"
        >
        </app-race-view-v1>
      </div>
      <div hlmTabsContent="Races">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 space-4 gap-4">
          @for(race of raceIds(); track race.id) {
          <section hlmCard class="w-full max-w-sm" (click)="openRaceModalToRace(race.id)">
            <div hlmCardHeader>
              <h3 hlmCardTitle>
                {{ raceDataService.Datasets()[selectedYear()].results[+race.id].race }}
              </h3>
              <div hlmCardAction>
                @if(raceDataService.Datasets()[selectedYear()].results[+race.id].finished) {
                <ng-icon
                  hlm
                  size="sm"
                  name="lucideCircleCheckBig"
                  color="oklch(62.7% 0.194 149.214)"
                />
                }
              </div>
            </div>
            <div hlmCardContent class="h-full">
              @if(raceDataService.Datasets()[selectedYear()].results[+race.id].finished) {
              <table>
                <tr>
                  <td class="px-3 py-2 font-semibold">Flags</td>
                  <td class="px-3 py-2">
                    {{ raceDataService.Datasets()[selectedYear()].results[+race.id].flags }}
                  </td>
                </tr>
                <tr>
                  <td class="px-3 py-2 font-semibold">Drivers</td>
                  <td class="px-3 py-2">
                    {{ raceDataService.Datasets()[selectedYear()].results[+race.id].drivers }}
                  </td>
                </tr>
                <tr>
                  <td class="px-3 py-2 font-semibold">Winner</td>
                  <td class="px-3 py-2">
                    {{ raceDataService.Datasets()[selectedYear()].results[+race.id].winner }}
                  </td>
                </tr>
                <tr>
                  <td class="px-3 py-2 font-semibold">DNF</td>
                  <td class="px-3 py-2">
                    {{ raceDataService.Datasets()[selectedYear()].results[+race.id].dnfs.length }}
                  </td>
                </tr>
              </table>
              }@else {
              <div class="flex justify-center h-full items-center-safe">
                <ng-icon
                  class="mb-10"
                  hlm
                  size="xl"
                  name="lucideHourglass"
                  color="oklch(0.928 0.006 264.531)"
                />
              </div>
              }
            </div>
          </section>
          }
        </div>
      </div>
    </hlm-tabs>
  </div>
</div>

<hlm-dialog [state]="raceDisplayModalIsOpen()" (closed)="raceDisplayModalIsOpen.set('closed')">
  <hlm-dialog-content
    *brnDialogContent="let ctx"
    class="overflow-y-auto overflow-x-hidden min-h-[70dvh] max-h-dvh"
  >
    <hlm-dialog-header>
      <h3 class="text-4xl bold">
        {{ displayedRaceResults().race }}
      </h3>
    </hlm-dialog-header>
    <app-race-view-v1
      [scores]="displayedRaceScores()"
      [results]="displayedRaceResults()"
      [predictions]="displayedRacePrediction()"
      [participants]="displayedRaceParticipants()"
      [displaySize]="'small'"
      ;
    >
    </app-race-view-v1>
  </hlm-dialog-content>
</hlm-dialog>
